const testInput = ['.......S.......','...............','.......^.......','...............','......^.^......','...............','.....^.^.^.....','...............','....^.^...^....','...............','...^.^...^.^...','...............','..^...^.....^..','...............','.^.^.^.^.^...^.','...............'];
const input = ['......................................................................S......................................................................','.............................................................................................................................................','......................................................................^......................................................................','.............................................................................................................................................','.....................................................................^.^.....................................................................','.............................................................................................................................................','....................................................................^.^.^....................................................................','.............................................................................................................................................','...................................................................^.^.^.^...................................................................','.............................................................................................................................................','..................................................................^.^...^.^..................................................................','.............................................................................................................................................','.................................................................^.^.^.^.^.^.................................................................','.............................................................................................................................................','................................................................^.....^.....^................................................................','.............................................................................................................................................','...............................................................^.^.^.......^.^...............................................................','.............................................................................................................................................','..............................................................^...^.^.^...^.^.^..............................................................','.............................................................................................................................................','.............................................................^.^.^.....^.^...^.^.............................................................','.............................................................................................................................................','............................................................^.........^.^.^.^...^............................................................','.............................................................................................................................................','...........................................................^.^.^...^...^...^.^...^...........................................................','.............................................................................................................................................','..........................................................^.^.^.^.^.^.....^...^.^.^..........................................................','.............................................................................................................................................','.........................................................^.^.....^.^.^.....^.......^.........................................................','.............................................................................................................................................','........................................................^.........^.^.^.^.^.^...^.^.^........................................................','.............................................................................................................................................','.......................................................^.....^.^.^...^.^.......^.....^.......................................................','.............................................................................................................................................','......................................................^...^.^.^.^.^.^.^.^.^.....^...^.^......................................................','.............................................................................................................................................','.....................................................^.^.^.^.^.^.^.^.^...............^.^.....................................................','.............................................................................................................................................','....................................................^.^.^.^.......^...^.^.^.^.^.^.....^.^....................................................','.............................................................................................................................................','...................................................^.^.....^.^.^.^.....^.^.^.^.^.^.^.^...^...................................................','.............................................................................................................................................','..................................................^.^.^...^.^.^...^.^.^.^.^.^.^.^.^.^.^...^..................................................','.............................................................................................................................................','.................................................^.^.^...^.....^.....^...^.^.^...^.......^.^.................................................','.............................................................................................................................................','................................................^...^.^.^...^.^.^.....^.^.^.^.^.^.....^.^...^................................................','.............................................................................................................................................','...............................................^.^.^.^.....^.....^...^.^.^.^.^...^.^.^.^...^.^...............................................','.............................................................................................................................................','..............................................^...^.^.^.^.^.^.^.^.^.^.^.^.....^.^.^.......^.^.^..............................................','.............................................................................................................................................','.............................................^.^...^.^.^.^...^...^.^...^.^...........^...^.^.^.^.............................................','.............................................................................................................................................','............................................^.^...^.^...^.^...^.^.^.^.....^.^.^.^.^...^.^.^...^.^............................................','.............................................................................................................................................','...........................................^.^.^.....^.^.^.^.^.......^.....^.^.^.^.^.^.....^.....^...........................................','.............................................................................................................................................','..........................................^.^.^.....^.^...^.^.^.^.....^.^.^.....^.^.....^.....^.^.^..........................................','.............................................................................................................................................','.........................................^.^.^.^...^.^.^.^...^.....^.^...^.....^.^.^.^.^.^.^...^.^.^.........................................','.............................................................................................................................................','........................................^.......^.^.^.^.^.^.^...^...^.^.^.....^...^...^.^.......^.^.^........................................','.............................................................................................................................................','.......................................^...^...^.^.....^.^...^.^...^.^.^.^...^.^.^.^.^...^.^.^...^...^.......................................','.............................................................................................................................................','......................................^.^.^...^.^.....^.^...^.^.....^.^...^...^.^.^.^...^.^.^...^.^...^......................................','.............................................................................................................................................','.....................................^.^.^...^.^.^.^.^...^.^.^.^.....^...^.......^.^.^.^.^.^.^.^...^...^.....................................','.............................................................................................................................................','....................................^...^.....^.^.^.^.^.^.^.^.....^.^...^.^.^.^...^.^.^.....^.^.....^.^.^....................................','.............................................................................................................................................','...................................^...^.^.^.^.^.^.....^...^...^.^.^...^.^.^.....^.....^.^.^...^.^.^.^.^.^...................................','.............................................................................................................................................','..................................^.^.^.......^.^.^...^...^.^.^...^.^.^.....^.^.^.^.^.^.^.^.^.^.^...^.^.^.^..................................','.............................................................................................................................................','.................................^.....^.^.^.^.^.^.....^.^.^.^.^.^.^.^.^...^.^...^...^.^.^.....^.^.....^...^.................................','.............................................................................................................................................','................................^.^.^...^.....^.^.^.^...^.^.^...^.....^.^.^.^.^.^.^...^.^.^.^...^.^.......^.^................................','.............................................................................................................................................','...............................^...^.^.^.^.^.....^.^.....^.....^.^.....^.......^.^.^.........^.^...^.^.^...^.^...............................','.............................................................................................................................................','..............................^.^.^.^.....^.^...^.^...^.^.....^.^.^.^.^.^...^...^.....^.^.^.^.^.^.^...^.^.^...^..............................','.............................................................................................................................................','.............................^...^.^.^.^.^.^...^.^.^.^.^.^.^.....^.^.^...^...^.^...^.^.^...^.^...^...^.^...^...^.............................','.............................................................................................................................................','............................^.^...^.......^.^.^...^.....^.....^.^.^.........^.^.^.^.^...^.^...^.^...^.^...^...^.^............................','.............................................................................................................................................','...........................^.......^.^.^.^.^.......^...^.^.......^.^...^.^.^.^...^.^.^.^.^.^...^.^...^.^...^.^.^.^...........................','.............................................................................................................................................','..........................^.^.^.....^.^.^.^.^...^.......^.^...^.^.^...^.^.^.^.^...^.^.^.^.^.^.....^.^.........^...^..........................','.............................................................................................................................................','.........................^.^...^.^.^.^.^.^.^...^.^...^...^...^...^.^...^...^.^.^.^.^...^...^...^...^.^.^.^...^.^...^.........................','.............................................................................................................................................','........................^.^.....^.^...^...^...^.^...^.^...^.^.^.^...^.^.^.^.^...^.^...^.^...^.^.^.^...^.^...^.^.^.^.^........................','.............................................................................................................................................','.......................^...^...^.......^.^.^.^.^.............^.^.^.^.^.^.^.^.^.^.^...^.^...^.....^.^.......^.^...^.^.^.......................','.............................................................................................................................................','......................^.^...^.^.^.^.^.^.^.^.^.^.^.^.^...^.^.^.^.^.^...^...^...^.^.^.^.^.....^...^...^.^.^.^.^.^.^...^.^......................','.............................................................................................................................................','.....................^.^...^.^.^.....^.^...^.^...^.^.^...^.^.^.^.^.^.^.^.^...^.....^.^.^.......^...^...^.....^.^...^.^.^.....................','.............................................................................................................................................','....................^.....^...^...^.^.^...^.^.^.^.^.^...^.^.^...^.^.....^.^.^.........^.^.^...^.^.^...^.^.^...^.^...^...^....................','.............................................................................................................................................','...................^.^.........^.^.......^.....^.^...^.^.^.^.^.....^.^.....^...^...^.^.^.^.^.^.^.^.....^...^.^...^.....^.^...................','.............................................................................................................................................','..................^.^...^.^.^...^...^.^...^.^...^.^...^.^.^.^...^.^.^.^.....^...^...^.^...^.^...^.^.^...^.....^...^...^...^..................','.............................................................................................................................................','.................^.^.^.^.^.^.........^...^.^.^...^.^.......^.^...^.....^.^...^.^.^.^.^.^.^...^.........^.^.^...^.^.^.....^.^.................','.............................................................................................................................................','................^.^.....^.^.^.^.^.^.^.^.^.^.^.^.^.^.^.^.^...^.^.^.^.^.^...^.^.^.^.^.^.^.^.^.^...^.^.^.^.^.^.^.^.^.^.^...^.^.^................','.............................................................................................................................................','...............^.....^.^...^.^.^.^.^...^.^.^.^.....^.^.^...^.^.....^.^.^.^.^.^.^.^.^.....^.^.^.^.^.^.......^.^.^.^.^.........^...............','.............................................................................................................................................','..............^.^...^.^.^.....^.^.^.^.^.^.^.^.^.^.^...^.^...^.^.^...^.^.^.^.^.^...^.^.^...^.^.^...^.^.^.^...^...^.^.^...^.^.^.^..............','.............................................................................................................................................','.............^.^.^.^.^.^.....^.^.^.^.^.^...^...^.^.^...^.^...^...^...^.^.^.^...^.^...^.....^.^.^.^.^.^...^.^.^.....^.^.^.^.^...^.............','.............................................................................................................................................','............^...^.^.......^.....^.^...^.......^.^...^.^.^.^...^.^.^.^.......^.^.^.^.^.^...^.^.^.....^.^.^.^.^.^.^.^.^.^.^...^.^.^............','.............................................................................................................................................','...........^.^...^.^.^...^.^.^.....^.....^.^...^...^.^.^...^...^.^.^...^...^...^...^.^...^.^.^.^...^.^...^...^.^.^.^.^.^.^.......^...........','.............................................................................................................................................','..........^.^.^.^.^.^.^.^...^...^.^...^...^.^...^...^...^...^.^.......^...^.^.^.....^.^.^...^...^.^.^.^.^.^.^.....^.^.^...^.^.^.^.^..........','.............................................................................................................................................','.........^.^.^.^.^.^.^.......^...^.^.^.^...^.^...^.^...^.^...^...^...^.....^.....^.^...^.^.^.^...^.^...^.^.^.^.....^.^.^.^.^.....^.^.........','.............................................................................................................................................','........^.^...^.^.^.^.....^.^...^.^.^...^...^.^.^.........^.^.....^.^.^.^.^.^.^.^.^.^...........^...^.....^.....^.^...^.^.^.^.^...^.^........','.............................................................................................................................................','.......^...^...^.^.........^.....^.^.^.^.^.^.^...^...^.^.^.^.....^.^.^.....^.^.^.....^.^.^.^.^...^...^.^.^.....^.^...^.^.^.^.....^.^.^.......','.............................................................................................................................................','......^...^...^.^...^.^.^.^.^.^...^.^.^.^.^.^.^...^.^.^.^...^.^.^.^.^.^.^.^.^.^.^.^.......^.^.^.^...^.^.^.^.^.^.^...^...^.^...^.^.....^......','.............................................................................................................................................','.....^.^.^.^...^.....^...^.^.^...^.^.^.^.^.^.^...^...^.^.^.^.^.^.^.^...^.^...^.^.^...^...^.^.^.^.....^.^...^.^.^.^.^.^...^...^.......^.^.....','.............................................................................................................................................','....^.^.^...^.^...^...^.^...^.^...^.^...^.^.....^.....^.^.^.^...^.^.^.....^.^.^...^.^.^...^.....^.^.^.^...^.^...^.....^.^.^.^.^.^...^.^.^....','.............................................................................................................................................','...^...^.^.....^.^.^.^.......^.^.^.....^.^...^.^.^.^.^.^...^.^.^...^.^.....^...^.^...^...^.....^.^...^...^...^...^...^...^.^...^.^.^.....^...','.............................................................................................................................................','..^...........^.^.^.^...^.^.^.....^.........^.^.^.^...^...^.....^.^...^.......^.^.^.^.^.^...^.^...^...^.^.^.^.^...^.^.^.....^.^.^...^.^.^.^..','.............................................................................................................................................','.^.....^.....^.^...^.^.............^.^.^.^...^...^.^.^.^...^.^.....^...^.^.^.^...^.......^...^.^.^.......^.....^.^.^.....^.........^...^.^.^.','.............................................................................................................................................'];
const INPUT_TO_USE = input;

let beams = new Set();
beams.add(INPUT_TO_USE[0].indexOf('S'));
let splits = 0;
for (const str of INPUT_TO_USE) {
  const row = str.split('');
  let newRow = Array(row.length);
  newRow = newRow.fill('.',0,row.length);
  const newBeams = new Set();
  for (const b of beams) {
    const beam = Number(b);
    if (row[beam] === '^') {
      newBeams.add(beam - 1);
      newBeams.add(beam + 1);
      splits++;
      newRow[beam-1] = '|';
      newRow[beam] = '^';
      newRow[beam+1] = '|';
    } else {
      newBeams.add(beam);
      newRow[beam] = '|';
    }
  }
  // console.log(newRow.join(''));
  beams = newBeams;
}
console.log(`Split ${splits} times`);

// Part 2
let beamCounts = Array(INPUT_TO_USE[0].length).fill(0);
beamCounts[INPUT_TO_USE[0].indexOf('S')] = 1;
for (const str of INPUT_TO_USE) {
  const row = str.split('');
  let newCounts = Array(INPUT_TO_USE[0].length).fill(0);
  for (let i = 0; i < row.length; i++) {
    if (beamCounts[i] === 0) {
      continue; // No beams going in here
    } else if (row[i] === '^') {
      newCounts[i-1] += beamCounts[i];
      newCounts[i+1] += beamCounts[i];
    } else {
      newCounts[i] += beamCounts[i];
    }
  }
  beamCounts = newCounts;
}
const total = beamCounts.reduce((acc, cur) => acc + cur, 0);
console.log(`Found ${total} timelines`);


/**
 * This would work but it's too big - "Maximum call stack size exceeded" :'(
 * Keeping for posterity
function tracePath(path, curPos, rowInd) {
  if (rowInd >= INPUT_TO_USE.length) {
    return [path];
  }
  const row = INPUT_TO_USE[rowInd].split('');
  if (row[curPos] === '^') {
    return [...tracePath(path + 'L', curPos - 1, rowInd + 1),...tracePath(path + 'R', curPos + 1, rowInd + 1)];
  } else {
    return tracePath(path + 'S', curPos, rowInd + 1);
  }
}

const paths = tracePath('S', INPUT_TO_USE[0].indexOf('S'), 1);
*/

/**
// Take 2 - also too slow :(
// Paths = 'I:LRLRLR' where I is the current index of the beam and LRLRLR is the path history
let timelines = new Set();
timelines.add(`${INPUT_TO_USE[0].indexOf('S')}:S`);
let i = 0;
for (const str of INPUT_TO_USE) {
  const row = str.split('');
  const newTimelines = new Set();
  for (const tStr of timelines) {
    const info = tStr.split(':');
    const curInd = Number(info[0]);
    const path = info[1];
    if (row[curInd] === '^') {
      newTimelines.add(`${curInd-1}:${path+'L'}`);
      newTimelines.add(`${curInd+1}:${path+'R'}`);
    } else {
      newTimelines.add(`${curInd}:${path+'S'}`);
    }
  }
  timelines = newTimelines;
}
console.log(`Found ${timelines.size} timelines`);
*/